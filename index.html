<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ü§ñ Customer Support Chatbot</title>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; }
        .chat-container { display: flex; flex-direction: column; height: 100vh; max-width: 900px; margin: 0 auto; background: white; box-shadow: 0 0 20px rgba(0,0,0,0.1); }
        .chat-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .chat-header h1 { margin: 0; font-size: 24px; font-weight: 600; }
        .session-info { display: flex; gap: 15px; align-items: center; font-size: 12px; }
        .btn-new-session, .btn-export { padding: 8px 16px; background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); border-radius: 4px; cursor: pointer; font-size: 12px; transition: background 0.3s; }
        .btn-new-session:hover, .btn-export:hover { background: rgba(255,255,255,0.3); }
        .error-banner { background: #ffebee; color: #c62828; padding: 12px; border-bottom: 2px solid #c62828; font-size: 13px; text-align: center; }
        .chat-messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 12px; background: white; }
        .welcome-message { text-align: center; color: #999; margin: auto; padding: 40px 20px; }
        .welcome-message p:first-child { font-size: 18px; font-weight: 500; margin-bottom: 10px; }
        .message { display: flex; flex-direction: column; animation: slideIn 0.3s ease-out; }
        .message-user { align-items: flex-end; }
        .message-bot { align-items: flex-start; }
        .message-sender { font-size: 11px; color: #999; margin-bottom: 4px; font-weight: 600; }
        .message-content { max-width: 70%; padding: 12px 16px; border-radius: 12px; word-wrap: break-word; position: relative; }
        .message-user .message-content { background: #667eea; color: white; border-bottom-right-radius: 4px; }
        .message-bot .message-content { background: #f0f0f0; color: #333; border-bottom-left-radius: 4px; }
        .message-error .message-content { background: #ffebee; color: #c62828; }
        .message-text { margin: 0 0 8px 0; line-height: 1.5; }
        .message-time { display: block; font-size: 11px; opacity: 0.7; margin-top: 6px; }
        .intent-badge { display: inline-block; padding: 3px 8px; border-radius: 12px; font-size: 10px; margin-top: 6px; font-weight: 600; }
        .intent-high { background: #4caf50; color: white; }
        .intent-medium { background: #ff9800; color: white; }
        .intent-low { background: #f44336; color: white; }
        .entity-tags { display: flex; flex-wrap: wrap; gap: 4px; margin-top: 8px; }
        .entity-tag { background: rgba(102, 126, 234, 0.2); color: #667eea; padding: 2px 8px; border-radius: 8px; font-size: 10px; font-weight: 600; }
        .feedback-buttons { display: flex; gap: 8px; margin-top: 8px; }
        .btn-feedback { background: transparent; border: none; cursor: pointer; font-size: 16px; padding: 4px; opacity: 0.6; transition: opacity 0.3s; }
        .btn-feedback:hover { opacity: 1; }
        .btn-feedback.active { opacity: 1; transform: scale(1.2); }
        .typing-indicator { display: flex; gap: 4px; padding: 12px 16px; background: #f0f0f0; border-radius: 12px; width: fit-content; }
        .typing-indicator span { width: 8px; height: 8px; border-radius: 50%; background: #999; animation: bounce 1.4s infinite; }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes bounce { 0%, 60%, 100% { opacity: 0.3; transform: translateY(0); } 30% { opacity: 1; transform: translateY(-10px); } }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .chat-input-area { display: flex; gap: 10px; padding: 15px; background: white; border-top: 1px solid #e0e0e0; }
        .chat-input { flex: 1; padding: 12px 16px; border: 1px solid #e0e0e0; border-radius: 24px; font-size: 14px; outline: none; transition: border-color 0.3s; }
        .chat-input:focus { border-color: #667eea; }
        .chat-input:disabled { background: #f5f5f5; opacity: 0.6; cursor: not-allowed; }
        .btn-send { padding: 12px 24px; background: #667eea; color: white; border: none; border-radius: 24px; cursor: pointer; font-weight: 600; transition: background 0.3s, transform 0.1s; white-space: nowrap; }
        .btn-send:hover:not(:disabled) { background: #764ba2; transform: translateY(-2px); }
        .btn-send:disabled { background: #ccc; cursor: not-allowed; }
        .chat-footer { padding: 10px; background: #f9f9f9; border-top: 1px solid #e0e0e0; text-align: center; color: #999; font-size: 11px; }
        .stats-panel { background: rgba(102, 126, 234, 0.1); padding: 8px 12px; border-radius: 8px; margin-bottom: 10px; }
        .stats-panel small { color: #667eea; font-weight: 600; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const API_BASE = "http://localhost:5000/api";

        function ChatApp() {
            const [messages, setMessages] = useState([]);
            const [input, setInput] = useState("");
            const [loading, setLoading] = useState(false);
            const [sessionId, setSessionId] = useState(null);
            const [error, setError] = useState("");
            const [stats, setStats] = useState(null);
            const chatEndRef = useRef(null);
            const inputRef = useRef(null);

            useEffect(() => {
                createNewSession();
                loadAnalytics();
            }, []);

            useEffect(() => {
                chatEndRef.current?.scrollIntoView({ behavior: "smooth" });
            }, [messages]);

            const createNewSession = async () => {
                try {
                    const response = await fetch(`${API_BASE}/session/create`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                    });
                    if (!response.ok) throw new Error("Failed to create session");
                    const data = await response.json();
                    setSessionId(data.session_id);
                    setMessages([]);
                    setError("");
                    inputRef.current?.focus();
                } catch (err) {
                    setError("Backend not running. Start with: python app.py");
                    console.error(err);
                }
            };

            const loadAnalytics = async () => {
                try {
                    const response = await fetch(`${API_BASE}/analytics/summary`);
                    if (response.ok) {
                        const data = await response.json();
                        setStats(data);
                    }
                } catch (err) {
                    console.error("Analytics error:", err);
                }
            };

            const sendMessage = async (e) => {
                e.preventDefault();
                if (!input.trim() || !sessionId) return;
                const messageText = input;
                const userMsg = { id: Date.now(), sender: "user", text: messageText, timestamp: new Date() };
                setMessages((prev) => [...prev, userMsg]);
                setInput("");
                setLoading(true);
                setError("");

                try {
                    const response = await fetch(`${API_BASE}/message/send`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ session_id: sessionId, message: messageText }),
                    });
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.error || "Failed to get response");
                    const botMsg = {
                        id: Date.now() + 1,
                        messageId: Date.now() + 1,
                        sender: "bot",
                        text: data.bot_response,
                        timestamp: new Date(),
                        intent: data.intent,
                        confidence: data.confidence,
                        entities: data.entities,
                        feedback: null,
                    };
                    setMessages((prev) => [...prev, botMsg]);
                    loadAnalytics();
                } catch (err) {
                    setError(err.message);
                    const errorMsg = { id: Date.now() + 1, sender: "bot", text: "Sorry, I encountered an error. Please try again.", timestamp: new Date(), isError: true };
                    setMessages((prev) => [...prev, errorMsg]);
                } finally {
                    setLoading(false);
                    inputRef.current?.focus();
                }
            };

            const submitFeedback = async (messageId, feedbackType) => {
                try {
                    await fetch(`${API_BASE}/feedback`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ message_id: messageId, feedback: feedbackType }),
                    });
                    setMessages((prev) =>
                        prev.map((msg) =>
                            msg.messageId === messageId ? { ...msg, feedback: feedbackType } : msg
                        )
                    );
                    loadAnalytics();
                } catch (err) {
                    console.error("Feedback error:", err);
                }
            };

            const exportConversation = async () => {
                try {
                    const response = await fetch(`${API_BASE}/conversation/export/${sessionId}`);
                    const data = await response.json();
                    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `conversation_${sessionId}.json`;
                    a.click();
                } catch (err) {
                    console.error("Export error:", err);
                }
            };

            const getIntentClass = (confidence) => {
                if (confidence >= 0.8) return "intent-high";
                if (confidence >= 0.6) return "intent-medium";
                return "intent-low";
            };

            return (
                <div className="chat-container">
                    <div className="chat-header">
                        <h1>ü§ñ Customer Support Chatbot</h1>
                        <div className="session-info">
                            <small>Session: {sessionId?.substring(0, 12)}...</small>
                            <button onClick={createNewSession} className="btn-new-session">New Chat</button>
                            <button onClick={exportConversation} className="btn-export">Export</button>
                        </div>
                    </div>

                    {error && <div className="error-banner">{error}</div>}

                    {stats && (
                        <div className="stats-panel">
                            <small>üìä Total Sessions: {stats.total_sessions} | Messages: {stats.total_messages} | Avg: {stats.avg_messages_per_session} msgs/session | üëç {stats.positive_feedback_count} üëé {stats.negative_feedback_count}</small>
                        </div>
                    )}

                    <div className="chat-messages">
                        {messages.length === 0 && (
                            <div className="welcome-message">
                                <p>Welcome! üëã</p>
                                <p>How can I assist you today?</p>
                                <small>Try: "What's my order #12345 status?" or "I want to return order 67890"</small>
                            </div>
                        )}

                        {messages.map((msg) => (
                            <div key={msg.id} className={`message message-${msg.sender} ${msg.isError ? "message-error" : ""}`}>
                                <div className="message-sender">{msg.sender === "user" ? "You" : "ü§ñ Support Agent"}</div>
                                <div className="message-content">
                                    <p className="message-text">{msg.text}</p>
                                    
                                    {msg.intent && (
                                        <span className={`intent-badge ${getIntentClass(msg.confidence)}`}>
                                            {msg.intent.replace(/_/g, ' ')} ({(msg.confidence * 100).toFixed(0)}%)
                                        </span>
                                    )}

                                    {msg.entities && Object.keys(msg.entities).length > 0 && (
                                        <div className="entity-tags">
                                            {Object.entries(msg.entities).map(([key, value]) => (
                                                <span key={key} className="entity-tag">{key}: {value}</span>
                                            ))}
                                        </div>
                                    )}

                                    {msg.sender === "bot" && !msg.isError && msg.messageId && (
                                        <div className="feedback-buttons">
                                            <button
                                                onClick={() => submitFeedback(msg.messageId, "positive")}
                                                className={`btn-feedback ${msg.feedback === "positive" ? "active" : ""}`}
                                                title="Helpful"
                                            >
                                                üëç
                                            </button>
                                            <button
                                                onClick={() => submitFeedback(msg.messageId, "negative")}
                                                className={`btn-feedback ${msg.feedback === "negative" ? "active" : ""}`}
                                                title="Not helpful"
                                            >
                                                üëé
                                            </button>
                                        </div>
                                    )}

                                    <small className="message-time">{msg.timestamp.toLocaleTimeString()}</small>
                                </div>
                            </div>
                        ))}

                        {loading && (
                            <div className="message message-bot">
                                <div className="typing-indicator">
                                    <span></span><span></span><span></span>
                                </div>
                            </div>
                        )}

                        <div ref={chatEndRef} />
                    </div>

                    <div className="chat-input-area">
                        <input
                            ref={inputRef}
                            type="text"
                            value={input}
                            onChange={(e) => setInput(e.target.value)}
                            onKeyPress={(e) => e.key === 'Enter' && sendMessage(e)}
                            placeholder="Type your message... Try: 'What's my order #12345 status?'"
                            disabled={loading || !sessionId}
                            maxLength="1000"
                            className="chat-input"
                        />
                        <button onClick={sendMessage} disabled={loading || !sessionId || !input.trim()} className="btn-send">
                            {loading ? "‚è≥ Sending..." : "üì§ Send"}
                        </button>
                    </div>

                    <div className="chat-footer">
                        <small>Chat ID: {sessionId?.substring(0, 12)}... | Messages: {messages.length} | Enhanced v2.0</small>
                    </div>
                </div>
            );
        }

        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<ChatApp />);
    </script>
</body>
</html>